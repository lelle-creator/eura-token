<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard MineCrypto - Auto-Login</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #8247e5; --bg: #0f111a; --card: #1a1d2b; --text: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .dashboard { background: var(--card); border-radius: 24px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); width: 100%; max-width: 400px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .token-logo { width: 100px; height: 100px; margin-bottom: 20px; filter: drop-shadow(0 0 10px var(--primary)); }
        .balance-label { font-size: 14px; color: #8b8e9b; text-transform: uppercase; }
        .balance-value { font-size: 42px; font-weight: bold; margin: 5px 0; color: #55ff55; }
        .user-badge { background: #333; padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-bottom: 20px; display: inline-block; }
        .info-card { background: rgba(130, 71, 229, 0.1); border-radius: 12px; padding: 15px; margin: 15px 0; border: 1px solid var(--primary); font-size: 13px; }
        .btn-claim { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-claim:disabled { background: #444; cursor: not-allowed; }
        .status-msg { margin-top: 15px; font-size: 12px; color: #aaa; }
    </style>
</head>
<body>

<div class="dashboard" id="mainContent">
    <img src="https://lelle-creator.github.io/eura-token/MineCrypto.png" alt="MineCrypto Logo" class="token-logo">
    
    <div id="userInfo" style="display:none;">
        <div class="user-badge" id="displayNick">Caricamento...</div>
        <div class="balance-label">Il tuo Saldo</div>
        <div id="balance" class="balance-value">0.00</div>
        <div style="color: #8b8e9b; margin-bottom: 15px;">Craft</div>
        
        <div class="info-card">
            <div>üí∞ Fee Prelievo: <b>20 Craft</b></div>
        </div>

        <button id="claimBtn" class="btn-claim" onclick="preleva()">PRELEVA SU WALLET</button>
    </div>

    <div id="loginSection">
        <h3>Benvenuto Esploratore</h3>
        <p style="font-size: 14px; color: #8b8e9b;">Collega il tuo wallet per accedere al saldo in-game.</p>
        <button class="btn-claim" onclick="connettiWallet()">CONNETTI METAMASK</button>
    </div>
    
    <div id="status" class="status-msg"></div>
    <a href="index.html" style="display:block; margin-top:20px; color:#666; text-decoration:none; font-size:12px;">‚Üê Torna al Portale</a>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAfSwk5rVvdsnBN9bcSf1I0qbYs1eyJHE",
        databaseURL: "https://eura-shop-minecraft-default-rtdb.firebaseio.com",
        projectId: "eura-shop-minecraft",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const contractAddress = "0xDcb8A657e39151D02C877299Db7790847174Af3a";
    const contractABI = [
        "function withdrawFee() view returns (uint256)",
        "function claimTokens(address to, uint256 amount) public"
    ];

    let userNick = "";
    let walletAddress = "";
    let saldoAttuale = 0;

    async function connettiWallet() {
        const status = document.getElementById('status');
        if (!window.ethereum) return alert("Installa MetaMask!");

        try {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const accounts = await provider.send("eth_requestAccounts", []);
            walletAddress = accounts[0].toLowerCase();
            
            status.innerText = "üîç Verifica associazione wallet...";
            
            // CERCA L'INDIRIZZO NEL DATABASE
            // Nota: Cerchiamo nel nodo 'wallet_to_nick' che link.html dovr√† creare
            db.ref('wallet_to_nick/' + walletAddress).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    userNick = snapshot.val();
                    mostraDashboard();
                } else {
                    status.innerHTML = "‚ùå Wallet non collegato.<br><a href='link.html' style='color:white'>Vai qui per collegare il tuo account Minecraft</a>";
                }
            });
        } catch (e) { status.innerText = "Errore: " + e.message; }
    }

    function mostraDashboard() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('userInfo').style.display = 'block';
        document.getElementById('displayNick').innerText = "üë§ " + userNick.toUpperCase();
        
        // Ascolta il saldo in tempo reale
        db.ref('utenti/' + userNick.toLowerCase() + '/saldo_virtuale').on('value', (snapshot) => {
            saldoAttuale = snapshot.val() || 0;
            document.getElementById('balance').innerText = saldoAttuale.toFixed(2);
            document.getElementById('claimBtn').disabled = (saldoAttuale < 21); // Almeno 21 per coprire la fee
        });
    }

    async function preleva() {
        const status = document.getElementById('status');
        try {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            const contract = new ethers.Contract(contractAddress, contractABI, signer);

            status.innerText = "üîÑ Firma il prelievo su MetaMask...";
            const amountToClaim = ethers.utils.parseUnits(saldoAttuale.toString(), 18);
            
            const tx = await contract.claimTokens(walletAddress, amountToClaim);
            status.innerText = "‚õèÔ∏è Transazione in corso...";
            await tx.wait();

            await db.ref('utenti/' + userNick.toLowerCase() + '/saldo_virtuale').set(0);
            status.innerHTML = "‚úÖ Token accreditati!";
        } catch (e) { status.innerText = "‚ùå " + e.message; }
    }
</script>
</body>
</html>
