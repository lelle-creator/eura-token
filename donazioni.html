<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donazioni EURa</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 40px 20px; background-color: #f8f9fa; }
        .container { max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        img { width: 100px; margin-bottom: 20px; border-radius: 50%; }
        input { width: 80%; padding: 12px; margin: 20px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 18px; text-align: center; }
        .btn-donate { background-color: #8247e5; color: white; padding: 15px 30px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; width: 85%; font-size: 16px; }
        .back-link { display: block; margin-bottom: 20px; color: #666; text-decoration: none; font-weight: bold; }
        .status { margin-top: 15px; font-size: 14px; color: #28a745; display: none; }
    </style>
</head>
<body>

<div class="container">
    <a href="index.html" class="back-link">‚Üê Torna alla Home</a>
    <img src="..." alt="Logo">
    <h1>Supporta il Progetto</h1>

    <div style="background: #f0f0f0; padding: 15px; ...">
        ...
    </div>

    <input type="number" id="amountInput" ...>
    <button id="donateBtn">Invia Donazione</button>

    <div id="statusMsg" style="display:none; ...">
        ...
    </div>
</div>

<script>
const contractAddress = '0x7beba6c16a4E1bDd04bF5a586ed45F3E0b505e22';
const myWallet = '0xE3B332d207a06C7c676D44294b98E5d7F704241A';

// Funzione per leggere il totale raccolto
async function updateCounter() {
    if (window.ethereum) {
        try {
            // Chiamata 'eth_call' per leggere il saldo (balanceOf) senza pagare gas
            const data = '0x70a08231' + '000000000000000000000000' + myWallet.replace('0x', '').toLowerCase();
            const balanceHex = await window.ethereum.request({
                method: 'eth_call',
                params: [{ to: contractAddress, data: data }, 'latest']
            });
            
            // Converte da esadecimale e toglie i 18 decimali
            const balance = Number(BigInt(balanceHex)) / Math.pow(10, 18);
            document.getElementById('totalRaised').innerText = balance.toLocaleString() + ' EURa';
        } catch (e) {
            document.getElementById('totalRaised').innerText = 'Connetti Wallet';
        }
    }
}

// Aggiorna il contatore all'avvio
updateCounter();

document.getElementById('donateBtn').addEventListener('click', async () => {
    const amount = document.getElementById('amountInput').value;
    if (!amount || amount <= 0) return alert("Inserisci un importo");

    if (window.ethereum) {
        try {
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            const hexAmount = BigInt(amount * Math.pow(10, 18)).toString(16).padStart(64, '0');
            const data = '0xa9059cbb' + '000000000000000000000000' + myWallet.replace('0x', '').toLowerCase() + hexAmount;

            const txHash = await window.ethereum.request({
                method: 'eth_sendTransaction',
                params: [{ to: contractAddress, from: accounts[0], data: data }],
            });

            // Mostra il ringraziamento e il link
            document.getElementById('statusMsg').style.display = 'block';
            document.getElementById('txLink').href = `https://amoy.polygonscan.com/tx/${txHash}`;
            
            // Aggiorna il contatore dopo un po' per dare tempo alla blockchain
            setTimeout(updateCounter, 5000);
        } catch (error) { alert("Errore: " + error.message); }
    }
});
</script>

</body>
</html>
